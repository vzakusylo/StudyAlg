# Got to ARM folder
cd 02-aks-advanced-configuration\labs\lab-01\ARM\APIM\

# Validate APIM ARM template. Run this command from lab-02 folder
az deployment group validate -g iac-ws2-rg --template-file template.json --parameters publisherEmail=ados@bk.ru userName=vzakusylo

# If no errors, deploy APIM ARM template. APIM deployment takes between 30 and 50 mins
az deployment group create -g iac-ws2-rg --template-file template.json --parameters publisherEmail=ados@bk.ru userName=vzakusylo



WS_PREFIX='iac-ws2'
YOUR_NAME='vz3'                 # I am using "evg"
BASE_RG="$WS_PREFIX-rg"                     # iac-ws2-rg
VNET_NAME=$WS_PREFIX-vnet                   # iac-ws2-vnet
LA_NAME="$WS_PREFIX-$YOUR_NAME-la"          # iac-ws2-evg-la
APPINSIGHTS_NAME="$WS_PREFIX-appinsights"   # iac-ws2-appinsights
PREFIX_NAME="$WS_PREFIX-pip-prefix"         # iac-ws2-pip-prefix
ACR_NAME="iacws2${YOUR_NAME}acr"            # iacws2evgacr

# Create base resource group
az group create -g $BASE_RG -l westeurope

# Create APIM VNet with AGW subnet
az network vnet create -g $BASE_RG -n $VNET_NAME --address-prefix 10.10.0.0/16 --subnet-name apim-net --subnet-prefix 10.10.0.0/27

# Create Public IP Prefix
az network public-ip prefix create --length 29 --location westeurope -n $PREFIX_NAME -g $BASE_RG

# Create AppInsight app
az monitor app-insights component create --app $APPINSIGHTS_NAME -l westeurope --kind web -g $BASE_RG --application-type web --retention-time 120

# Create Log Analytics
az monitor log-analytics workspace create -g $BASE_RG -n $LA_NAME

# Create Azure Container Registry
az acr create -g $BASE_RG -n $ACR_NAME --sku Basic
